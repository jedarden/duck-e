version: '3.8'

# Hardened Docker Compose Configuration for DUCK-E
# Security Review: 2025-10-10
# Addresses: COM-001 through COM-006

services:
  duck-e:
    build:
      context: .
      dockerfile: docs/security/dockerfile.hardened
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: ducke:latest
    container_name: duck-e

    # Network configuration - isolated network
    networks:
      - ducke-network
    ports:
      # SECURITY: Bind to localhost only, not exposed to public internet
      - "127.0.0.1:8000:8000"

    # Environment configuration
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - ENVIRONMENT=production

    # SECURITY FIX COM-001: Resource limits to prevent DoS
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
          pids: 100
        reservations:
          cpus: '0.5'
          memory: 512M

    # SECURITY FIX COM-004: Security hardening options
    security_opt:
      - no-new-privileges:true
      - apparmor=docker-default

    # SECURITY FIX COM-005: Drop all capabilities, add only required ones
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE

    # SECURITY FIX COM-003: Read-only root filesystem
    read_only: true
    tmpfs:
      - /tmp:size=100M,mode=1777,noexec,nosuid,nodev
      - /run:size=10M,mode=755,noexec,nosuid,nodev
      - /tmp/ducke:size=50M,mode=1777,noexec,nosuid,nodev
      - /var/log/ducke:size=100M,mode=755,noexec,nosuid,nodev

    # Restart policy
    restart: unless-stopped

    # SECURITY: User namespace remapping
    user: "1000:1000"

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Logging configuration with rotation
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,environment"
        tag: "ducke-app"

    # SECURITY FIX COM-006: Explicitly prevent privileged mode
    privileged: false

    # Isolation settings
    ipc: private

    # Labels for management and monitoring
    labels:
      - "com.ducke.security.scan=enabled"
      - "com.ducke.security.team=security@ducke.app"
      - "com.ducke.environment=production"
      - "com.ducke.version=1.0.0"

  # Nginx reverse proxy for TLS termination
  nginx:
    image: nginx:1.27-alpine
    container_name: ducke-nginx

    # Network configuration
    networks:
      - ducke-network
    ports:
      - "443:443"
      - "80:80"

    # Volumes (read-only)
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/dhparam.pem:/etc/nginx/dhparam.pem:ro
      - ./nginx/snippets:/etc/nginx/snippets:ro

    depends_on:
      duck-e:
        condition: service_healthy

    restart: unless-stopped

    # Security hardening
    security_opt:
      - no-new-privileges:true
      - apparmor=docker-default

    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETGID
      - SETUID
      - DAC_OVERRIDE

    # Read-only with specific writable paths
    read_only: true
    tmpfs:
      - /var/cache/nginx:size=50M,mode=755,noexec,nosuid,nodev
      - /var/run:size=10M,mode=755,noexec,nosuid,nodev
      - /var/log/nginx:size=100M,mode=755,noexec,nosuid,nodev

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/status"]
      interval: 30s
      timeout: 10s
      retries: 3

    labels:
      - "com.ducke.service=reverse-proxy"
      - "com.ducke.security.scan=enabled"

  # Prometheus monitoring
  prometheus:
    image: prom/prometheus:v2.54.1
    container_name: ducke-prometheus

    networks:
      - ducke-network

    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus

    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'

    restart: unless-stopped

    security_opt:
      - no-new-privileges:true

    cap_drop:
      - ALL

    user: "nobody"

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

    labels:
      - "com.ducke.service=monitoring"

  # Grafana dashboards
  grafana:
    image: grafana/grafana:11.3.0
    container_name: ducke-grafana

    networks:
      - ducke-network

    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro

    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-changeme}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=https://grafana.ducke.app
      - GF_SECURITY_COOKIE_SECURE=true
      - GF_SECURITY_STRICT_TRANSPORT_SECURITY=true

    restart: unless-stopped

    security_opt:
      - no-new-privileges:true

    cap_drop:
      - ALL

    user: "472:472"

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

    labels:
      - "com.ducke.service=dashboards"

networks:
  ducke-network:
    driver: bridge
    internal: false
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1
    driver_opts:
      com.docker.network.bridge.name: ducke-br0
      com.docker.network.bridge.enable_icc: "false"
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.driver.mtu: "1500"
    labels:
      - "com.ducke.network=internal"

volumes:
  prometheus-data:
    driver: local
    labels:
      - "com.ducke.volume=metrics"

  grafana-data:
    driver: local
    labels:
      - "com.ducke.volume=dashboards"
